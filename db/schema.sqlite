-- SQLite version of HussEyquation Database Schema

CREATE TABLE players (
  player_id INTEGER PRIMARY KEY AUTOINCREMENT,
  nba_player_id TEXT UNIQUE,
  full_name TEXT NOT NULL,
  primary_pos TEXT
);

CREATE TABLE teams (
  team_id INTEGER PRIMARY KEY AUTOINCREMENT,
  abbr TEXT UNIQUE NOT NULL,
  name TEXT
);

CREATE TABLE seasons (
  season_id INTEGER PRIMARY KEY,
  start_date DATE,
  end_date DATE,
  status TEXT DEFAULT 'historical'
);

CREATE TABLE snapshots (
  snapshot_id INTEGER PRIMARY KEY AUTOINCREMENT,
  season_id INTEGER REFERENCES seasons(season_id),
  snapshot_date DATE NOT NULL,
  source_hash TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE player_snapshot_stats (
  snapshot_id INTEGER REFERENCES snapshots(snapshot_id),
  player_id INTEGER REFERENCES players(player_id),
  team_id INTEGER REFERENCES teams(team_id),
  g INTEGER, 
  mp INTEGER,
  per REAL,
  ws REAL,
  ws48 REAL,
  bmp REAL,
  vorp REAL,
  PRIMARY KEY (snapshot_id, player_id)
);

CREATE TABLE player_snapshot_ranks (
  snapshot_id INTEGER REFERENCES snapshots(snapshot_id),
  player_id INTEGER REFERENCES players(player_id),
  per_rank INTEGER, 
  ws_rank INTEGER, 
  ws48_rank INTEGER, 
  bmp_rank INTEGER, 
  vorp_rank INTEGER,
  huss_score REAL,
  huss_rank INTEGER,
  qualified INTEGER DEFAULT 1,
  PRIMARY KEY (snapshot_id, player_id)
);

CREATE TABLE season_final_ranks (
  season_id INTEGER REFERENCES seasons(season_id),
  player_id INTEGER REFERENCES players(player_id),
  per_rank INTEGER, 
  ws_rank INTEGER, 
  ws48_rank INTEGER, 
  bmp_rank INTEGER, 
  vorp_rank INTEGER,
  huss_score REAL,
  huss_rank INTEGER,
  qualified INTEGER DEFAULT 1,
  PRIMARY KEY (season_id, player_id)
);

-- Indexes
CREATE INDEX ix_ranks_snapshot ON player_snapshot_ranks (snapshot_id, huss_rank);
CREATE INDEX ix_ranks_qual ON player_snapshot_ranks (snapshot_id, qualified, huss_rank);
CREATE INDEX ix_stats_team ON player_snapshot_stats (snapshot_id, team_id);
CREATE INDEX ix_players_nbaid ON players (nba_player_id);

-- Insert sample data for testing
INSERT INTO seasons (season_id, start_date, end_date, status) VALUES 
(2025, '2024-10-15', '2025-06-30', 'active');

INSERT INTO teams (abbr, name) VALUES 
('DEN', 'Denver Nuggets'),
('DAL', 'Dallas Mavericks'),
('BOS', 'Boston Celtics'),
('LAL', 'Los Angeles Lakers'),
('GSW', 'Golden State Warriors');

INSERT INTO players (nba_player_id, full_name, primary_pos) VALUES 
('203999', 'Nikola Jokic', 'C'),
('1629029', 'Luka Doncic', 'PG'),
('1627759', 'Jayson Tatum', 'SF'),
('2544', 'LeBron James', 'SF'),
('201939', 'Stephen Curry', 'PG');

INSERT INTO snapshots (season_id, snapshot_date) VALUES 
(2025, '2024-12-12');

-- Sample stats data
INSERT INTO player_snapshot_stats (snapshot_id, player_id, team_id, g, mp, per, ws, ws48, bmp, vorp) VALUES 
(1, 1, 1, 30, 960, 32.8, 7.2, 0.298, 11.7, 4.8),
(1, 2, 2, 28, 920, 30.1, 6.5, 0.245, 9.2, 3.9),
(1, 3, 3, 32, 1100, 28.9, 6.8, 0.235, 8.1, 3.5),
(1, 4, 4, 29, 950, 25.2, 5.9, 0.198, 7.3, 2.8),
(1, 5, 5, 31, 980, 26.8, 6.1, 0.215, 6.9, 2.9);

-- Sample ranks data  
INSERT INTO player_snapshot_ranks (snapshot_id, player_id, per_rank, ws_rank, ws48_rank, bmp_rank, vorp_rank, huss_score, huss_rank, qualified) VALUES 
(1, 1, 1, 1, 1, 1, 1, 1.0, 1, 1),
(1, 2, 2, 3, 2, 2, 2, 2.2, 2, 1),
(1, 3, 3, 2, 3, 3, 3, 2.8, 3, 1),
(1, 4, 5, 5, 5, 4, 5, 4.8, 5, 1),
(1, 5, 4, 4, 4, 5, 4, 4.2, 4, 1);